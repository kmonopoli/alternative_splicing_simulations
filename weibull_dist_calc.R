#!/usr/local/bin/Rscript
library(stats)





# Fragment and Read Function
fragment_and_read <- function(df , eta_val = 200, insertsize = c(200, 300))
{
  # Select a fragment from each transcript, size select, and return the starting position of the
  # resulting reads relative to the length of the transcript
  # Inputs: 
  #   df - dataFrame of:
  #     splice types - 0,1,2,3
  #     lengths - the lengths of the transcript
  #   eta_val - the eta value input to the Weibull distribution
  #   insertsize - a list of length two with the lower and upper bound for fragments
  # Outputs:
  #   fragments - a data frame with the start positions of the filtered fragments and the index
  #               of the transcript that it came from (columns: transcript, start)

  # sample lengths from a weibull distribution for each transcript and transform them to the length 
  # of the transcripts
  
  lengths <- df[['lengths']]
  splice_types <- df[['splice_types']]
  print(splice_types)
  deltas = log10(lengths)
  ns_minus_1 = pmax(round(lengths/eta_val/gamma(1/deltas + 1)) - 1, 0)
  xis = lapply(ns_minus_1, function(n) {diff(sort(c(runif(n), 0, 1)))})
  xis_transformed = mapply(function(x, d) {x^(1/d)}, xis, deltas, SIMPLIFY = F)
  delta_is = mapply(function(len, x_t) {round(len*x_t/sum(x_t))}, lengths, xis_transformed, SIMPLIFY = F)

  # get all the start and end points of the fragments
  starts = lapply(delta_is, function(d) {
    if (length(d) > 1) {
      c(sample(min(insertsize[1], d[1]), 1), cumsum(d[1:(length(d)-1)]))
    } else{
      sample(min(insertsize[1], d), 1)
    }
  })
  ends = lapply(delta_is, function(d) {
    if (length(d) > 1) {
      c(cumsum(d[1:(length(d)-1)]), sum(d)-sample(min(insertsize[1], sum(d) - d[length(d)]), 1))
    } else{
      d
    }
  })

  # convert to a data frame of fragments and associated transcritp index
  #fragments = data.frame(transcript = rep(1:length(deltas), lengths(delta_is)),
  fragments = data.frame(transcript = rep(1:length(deltas), unlist(lapply(delta_is, length))),
                         start = unlist(starts),
                         end = unlist(ends))
  fragments$length = fragments$end - fragments$start

  # Filter fragments by length and return
  fragments = fragments[fragments$length >= insertsize[1] & fragments$length <= insertsize[2],]
  return(fragments[c('transcript', 'start')])
}



# read in info (as from command line)
## args: lengths, splice types (as 2 separate arrays)
args = (commandArgs(trailingOnly=TRUE))
print("running weibull dist")

# ####################
# # FOR TESTING: ##
#  eta_val = 200
#  insertsize = c(200, 300)
# args <- "[[5946, 1475, 500, 500, 5741, 500, 500, 500, 500, 500, 500, 500, 1602, 4574, 5270, 5723, 500, 4889, 3233, 5263, 500, 500, 500, 500, 500, 3351, 500, 500, 2474, 500, 500, 500, 500, 500, 500, 2804, 500, 500, 5620, 500, 1860, 5587, 500, 5449, 500, 2758, 4463, 500, 3214, 1011, 500, 500, 500, 500, 500, 500, 2186, 500, 1170, 500, 500, 500, 500, 5585, 500, 500, 500, 500, 1946, 1027, 6106, 5222, 500, 500, 2795, 1041, 500, 500, 500, 500, 500, 3680, 500, 500, 500, 500, 500, 5661, 500, 500, 500, 3543, 3985, 500, 500, 500, 500, 500, 3434, 500, 500, 500, 500, 500, 500, 500, 1942, 500, 500, 500, 500, 4007, 500, 500, 500, 500, 500, 5231, 500, 500, 500, 5903, 500, 500, 1413, 3458, 1532, 500, 500, 1051, 500, 500, 500, 5177, 500, 3572, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 4499, 500, 500, 500, 500, 500, 5960, 500, 500, 500, 500, 500, 500, 3221, 500, 4304, 1397, 500, 500, 2388, 500, 500, 500, 500, 500, 1488, 500, 500, 5917, 5209, 500, 4012, 500, 500, 2084, 1690, 500, 1877, 2263, 500, 5317, 500, 500, 2030, 500, 500, 500, 500, 500, 5031, 500, 3811, 2227, 500, 500, 500, 3787, 500, 500, 2121, 1422, 500, 500, 2141, 500, 500, 500, 1706, 500, 4424, 500, 500, 500, 2157, 5779, 500, 3861, 500, 500, 5847, 500, 500, 500, 5950, 500, 500, 500, 500, 500, 500, 3614, 500, 5188, 500, 500, 500, 500, 500, 500, 2165, 4589, 500, 5301, 500, 500, 500, 500, 3369, 500, 500, 1275, 1264, 500, 5566, 500, 500, 5051, 1052, 500, 500, 500, 500, 500, 1345, 500, 500, 4227, 500, 3205, 2351, 2667, 4936, 500, 500, 500, 5852, 500, 500, 3000, 1368, 5781, 1150, 500, 500, 1386, 500, 3838, 500, 500, 3027, 500, 500, 500, 4518, 3844, 500, 500, 500, 500, 3676, 500, 500, 1485, 500, 500, 1831, 3859, 500, 500, 500, 3151, 500, 500, 1687, 2889, 500, 5850, 5721, 4461, 1582, 500, 500, 4837, 2272, 500, 500, 500, 500, 500, 3837, 500, 2299, 500, 500, 1909, 500, 4583, 500, 4105, 2461, 500, 500, 500, 2230, 1022, 500, 5865, 500, 5033, 4626, 500, 500, 500, 500, 5273, 500, 500, 500, 1065, 500, 500, 500, 500, 500, 4846, 500, 500, 500, 1439, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 1871, 500, 500, 500, 500, 500, 500, 500, 2528, 1792, 3705], [0, 4, 2, 2, 0, 2, 2, 2, 2, 2, 2, 2, 3, 0, 0, 0, 2, 0, 0, 0, 2, 2, 2, 2, 2, 0, 2, 2, 4, 2, 2, 2, 2, 2, 2, 4, 2, 2, 0, 2, 1, 0, 2, 0, 2, 4, 0, 2, 0, 4, 2, 2, 2, 2, 2, 2, 4, 2, 4, 2, 2, 2, 2, 0, 2, 2, 2, 2, 4, 4, 0, 0, 2, 2, 4, 4, 2, 2, 2, 2, 2, 0, 2, 2, 2, 2, 2, 0, 2, 2, 2, 0, 0, 2, 2, 2, 2, 2, 0, 2, 2, 2, 2, 2, 2, 2, 4, 2, 2, 2, 2, 0, 2, 2, 2, 2, 2, 0, 2, 2, 2, 0, 2, 2, 4, 0, 4, 2, 2, 4, 2, 2, 2, 0, 2, 0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 2, 2, 2, 2, 2, 0, 2, 2, 2, 2, 2, 2, 0, 2, 0, 4, 2, 2, 4, 2, 2, 2, 2, 2, 4, 2, 2, 0, 0, 2, 0, 2, 2, 4, 4, 2, 4, 4, 2, 0, 2, 2, 3, 2, 2, 2, 2, 2, 0, 2, 0, 4, 2, 2, 2, 0, 2, 2, 3, 4, 2, 2, 4, 2, 2, 2, 4, 2, 0, 2, 2, 2, 4, 0, 2, 0, 2, 2, 0, 2, 2, 2, 0, 2, 2, 2, 2, 2, 2, 0, 2, 0, 2, 2, 2, 2, 2, 2, 4, 0, 2, 0, 2, 2, 2, 2, 0, 2, 2, 4, 4, 2, 0, 2, 2, 0, 4, 2, 2, 2, 2, 2, 4, 2, 2, 0, 2, 0, 4, 4, 0, 2, 2, 2, 0, 2, 2, 0, 4, 0, 4, 2, 2, 4, 2, 0, 2, 2, 0, 2, 2, 2, 0, 0, 2, 2, 2, 2, 0, 2, 2, 4, 2, 2, 4, 0, 2, 2, 2, 0, 2, 2, 4, 4, 2, 0, 0, 0, 4, 2, 2, 0, 4, 2, 2, 2, 2, 2, 0, 2, 4, 2, 2, 4, 2, 0, 2, 0, 4, 2, 2, 2, 4, 4, 2, 0, 2, 0, 0, 2, 2, 2, 2, 0, 2, 2, 2, 3, 2, 2, 2, 2, 2, 0, 2, 2, 2, 4, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 4, 2, 2, 2, 2, 2, 2, 2, 4, 4, 0]]"
# args <- "[[9426, 13500, 6295, 3265, -16500, 1951, 9165, 13500, 13500, 13500, 15011, 8976, 13500, -16500, 13500, 12924, 1387, 13500, 14266, -16500, -16500, -16500, 11204, -16500, 13500, -16500, 6982, 4239, 10497, -16500, 7449, 8710, -16500, 15828, 7914, 13140, 13654, 4542, 6227, 5396, 13500, -16500, 13500, 3225, 9937, 13500, -16500, 8704, 13500, 8940, 2536, 6314, -16500, 12047, 15043, 13500, 5661, 1423, 13500, 12393, 6809, 12323, 4753, -16500, 13500, 9440, 13699, 13500, 13500, 12126, 13500, 1228, 3786, 10454, -16500, 9030, -16500, -16500, 3608, 13500, -16500, -16500, 13500, 3825, 13500, 2459, 3768, -16500, 13500, 11046, 11863, -16500, 15231, 15129, 6166, 14037, 13500, 9668, 7739, 13500, 5114, 4890, -16500, 13500, 13203, -16500, 13500, 4274, 6648, 4236, 10789, 11895, 3132, 13500, 4270, 7823, 11429, 8305, 6553, 13500, -16500, -16500, 1619, -16500, 13500, 7420, 1308, 13500, 8018, 5915, 7980, 13500, -16500, 14823, 7842, 9874, 13500, -16500, 8942, 2856, -16500, 12854, 1287, 2648, 13500, 2210, 13500, 13327, 3109, 13500, 11959, 13500, 5840, -16500, -16500, 13500, 13500, -16500, 2413, 13446, 10641, -16500, 5635, 13500, 13500, 4385, 13500, 13500, 13500, 6654, 13500, 13500, 10615, -16500, 13500, 8318, 11471, 2516, 2997, 13500, 15987, 4404, 1060, 13500, 7687, 13500, 3848, 9409, 13500, -16500, 11813, 12489, 9487, 10542, 13500, 13500, -16500, -16500, 5388, 6748, -16500, 13500, -16500, 13500, 9280, -16500, 8010, 13500, -16500, 8262, -16500, -16500, 1677, 13500, 11949, 4705, 15367, -16500, 14582, 13259, 6307, 11127, 1181, 14671, 9001, 10017, 5923, -16500, 13500, 2770, 11613, 13500, 5357, -16500, 13500, 7873, 13500, 13500, 8589, 8868, 13500, 2345, -16500, 13500, 4262, 13500, 12501, 13500, 13500, -16500, -16500, -16500, 2130, 7596, 5533, 5561, 13500, -16500, 9156, 13859, 9994, 13500, 13500, 13500, -16500, 7712, 10076, 12386, 4742, 1220, 1414, 4600, 13500, 1106, 7803, 3165, 7230, 13500, 13500, 10958, 5422, 1883, 9526, 1946, 13879, 5431, 8012, 10245, 14260, 13500, 1907, 13500, 2390, 2058, 9594, -16500, -16500, 5834, -16500, 11277, -16500, 13500, 13500, 13500, 6789, 13500, 12100, 13479, 9756, -16500, 1266, 13500, 11705, 13158, 7912, -16500, 5924, 3363, -16500, 15589, 6861, -16500, -16500, 7522, 5082, 3578, 1095, 7157, 7550, -16500, 9061, 7371, -16500, 11980, 8365, 9205, 13500, 13500, -16500, -16500, 7254, 8690, 7400, 10621, 13500, 6563, 5423, 8207, 13500, 7920, 6483, -16500, 13500, 6669, 6689, 2252, 13500, -16500, 13362, 2976, 5651, -16500, 11726, 13500, 13092, 13500, 10737, 2458, 1824, -16500, 10906, -16500, 13500, 10200, 13500, -16500, -16500, 10190, -16500, 9838, 12881, 13500, 9183, 4533, 15953, 13500, 2652, 13500, 12054, 6324, 15448, 13500, 13729, 10184, -16500, 3220, 10255, 13500, -16500, 13500], [4, 3, 3, 4, 2, 3, 4, 3, 3, 3, 4, 3, 3, 2, 3, 4, 4, 3, 4, 2, 2, 2, 4, 2, 3, 2, 3, 4, 3, 2, 4, 4, 2, 4, 4, 3, 4, 3, 3, 4, 3, 2, 3, 4, 4, 3, 2, 3, 3, 4, 3, 3, 2, 4, 4, 3, 3, 3, 3, 3, 3, 4, 4, 2, 3, 3, 4, 3, 3, 4, 3, 3, 4, 4, 2, 3, 2, 2, 3, 3, 2, 2, 3, 3, 3, 3, 4, 2, 3, 3, 3, 2, 4, 4, 4, 4, 3, 3, 3, 3, 4, 4, 2, 3, 4, 2, 3, 3, 4, 3, 3, 3, 3, 3, 4, 4, 3, 3, 4, 3, 2, 2, 4, 2, 3, 4, 4, 3, 3, 3, 4, 3, 2, 4, 4, 3, 3, 2, 3, 3, 2, 3, 3, 4, 3, 4, 3, 3, 3, 3, 4, 3, 4, 2, 2, 3, 3, 2, 4, 3, 4, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 2, 3, 3, 3, 4, 4, 3, 4, 4, 4, 3, 4, 3, 4, 3, 3, 2, 4, 4, 3, 3, 3, 3, 2, 2, 3, 3, 2, 3, 2, 3, 4, 2, 4, 3, 2, 3, 2, 2, 4, 3, 4, 4, 4, 2, 4, 3, 4, 4, 4, 4, 3, 3, 4, 2, 3, 4, 4, 3, 3, 2, 3, 3, 3, 3, 4, 4, 3, 3, 2, 3, 3, 3, 4, 3, 3, 2, 2, 2, 3, 3, 4, 4, 3, 2, 3, 4, 3, 3, 3, 3, 2, 3, 3, 4, 4, 4, 4, 4, 3, 4, 3, 4, 3, 3, 3, 3, 4, 3, 3, 4, 4, 4, 4, 3, 4, 3, 3, 3, 4, 3, 4, 2, 2, 4, 2, 4, 2, 3, 3, 3, 4, 3, 4, 4, 3, 2, 3, 3, 4, 3, 3, 2, 3, 4, 2, 4, 3, 2, 2, 4, 3, 3, 4, 3, 4, 2, 4, 4, 2, 3, 3, 4, 3, 3, 2, 2, 3, 3, 4, 3, 3, 4, 3, 3, 3, 3, 4, 2, 3, 4, 4, 3, 3, 2, 4, 4, 4, 2, 3, 3, 3, 3, 4, 3, 3, 2, 3, 2, 3, 4, 3, 2, 2, 3, 2, 3, 4, 3, 3, 4, 4, 3, 3, 3, 4, 3, 4, 3, 4, 3, 2, 3, 3, 3, 2, 3]]"
# ####################


# Passing in an array of lengths and splice types from python script
q <- gsub("\\[|\\]" ,"", unlist(strsplit(args, split="]"))) # splits input into separate lists

lengths <-as.numeric(unlist(strsplit(q[1], split=", ")))
splice_types <-(as.numeric(unlist(strsplit(q[2], split=", ")))) ## TODO: need to include these in analysis
splice_types <- splice_types[!is.na(splice_types)]
df <- data.frame(splice_types = splice_types,lengths=lengths)
start_pos = fragment_and_read(df)
print(start_pos)
print(paste(gsub("\n","",as.character(start_pos[1]))," ",gsub("\n","",as.character(start_pos[2]))))

